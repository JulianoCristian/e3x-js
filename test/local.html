<html>
<head>
	<script src="../includes/forge.min.js"></script>
	<script src="../includes/jsbn.js"></script>
	<script src="../includes/jsbn2.js"></script>
	<script src="../includes/ec.js"></script>
	<script src="../includes/sec.js"></script>
	<script src="../includes/prng4.js"></script>
	<script src="../includes/rng.js"></script>
	<script src="../lib/dhash.js"></script>
	<script src="../lib/util.js"></script>
	<script src="../lib/open.js"></script>
	<script src="../seeds.js"></script>
</head>
<body>
	<h1>hi</h1>
	<form>
		<input size="100"><br>
		<input size="50"><input size="50"><br>
		<textarea cols="100" rows="20"></textarea><br>
		<textarea cols="100" rows="20"></textarea><input type="button" value="go" onclick="otest()">
	</form>
	<script>
var rsa = forge.pki.rsa;
var pki = forge.pki;
var asn1 = forge.asn1;

var seed = seeds[0];
seed.public = pki.publicKeyFromPem(seed.pubkey);
seed.hashname = key2hn(seed.public);

function getId(callback)
{
	if(localStorage.pubkey)
	{
		var ret = {public:pki.publicKeyFromPem(localStorage.pubkey), private:pki.privateKeyFromPem(localStorage.prikey)}
		console.log("returning key",ret);
		return callback(ret);
	}

	// generate/save one nicely
	console.log("generating 2048 rsa keypair");
	var state = rsa.createKeyPairGenerationState(2048, 0x10001);
	var steps = 0;
	var step = function() {
	  // run for 100 ms
	  if(!rsa.stepKeyPairGenerationState(state, 100)) {
		console.log("step",steps++);
	    setTimeout(step, 1);
	  } else {
		localStorage.pubkey = pki.publicKeyToPem(state.keys.publicKey);
		localStorage.prikey = pki.privateKeyToPem(state.keys.privateKey);
		getId(callback);
	  }
	};
	setTimeout(step);	
}


var open;
getId(function(id){
	document.forms[0][0].value = key2hn(id.public);
	open = openize(id, seed);
	document.forms[0][3].value = open.packet.toHex();
})


function otest()
{
	var packet = forge.util.hexToBytes(document.forms[0][4].value);
	getId(function(id){
		var opened = deopenize(id, packet);
		var secret = ecdh(open.ecc.private, opened.ecc.public);
		console.log("secret",secret);
	});
}

	</script>
</body>
</html>