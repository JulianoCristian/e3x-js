<html>
<head>
	<script src="../includes/forge.min.js"></script>
	<script src="../includes/jsbn.js"></script>
	<script src="../includes/jsbn2.js"></script>
	<script src="../includes/ec.js"></script>
	<script src="../includes/sec.js"></script>
	<script src="../includes/prng4.js"></script>
	<script src="../includes/rng.js"></script>
	<script src="../lib/dhash.js"></script>
	<script src="../lib/util.js"></script>
	<script src="../lib/open.js"></script>
</head>
<body>
	<h1>hi</h1>
	<form>
		<input size="100"><br>
		<input size="50"><input size="50"><br>
		<textarea cols="100" rows="20"></textarea><br>
		<textarea cols="100" rows="20"></textarea><input type="button" value="go" onclick="otest()">
	</form>
	<script>
var rsa = forge.pki.rsa;
var pki = forge.pki;
var asn1 = forge.asn1;

var seed = {
    "ip": "208.68.164.253",
    "port": 42424,
    "pubkey": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxoQkh8uIPe18Ym5kO3VX\nqPhKsc7vhrMMH8HgUO3tSZeIcowHxZe+omFadTvquW4az7CV/+3EBVHWzuX90Vof\nsDsgbPXhzeV/TPOgrwz9B6AgEAq+UZ+cs5BSjZXXQgFrTHzEy9uboio+StBt3nB9\npLi/LlB0YNIoEk83neX++6dN63C3mSa55P8r4FvCWUXue2ZWfT6qamSGQeOPIUBo\n4aiN6P4Hzqaco6YRO9v901jV+nq0qp0yHKnxlIYgiY7501vXWceMtnqcEkgzX4Rr\n7nIoA6QnlUMkTUDP7N3ariNSwl8OL1ZjsFJz7XjfIJMQ+9kd1nNJ3sb4o3jOWCzj\nXwIDAQAB\n-----END PUBLIC KEY-----\n"}

seed = 	{
	    "ip": "10.17.1.221",
	    "port": 42424,
	    "hashname": "8f83606d57ab52161aec9868725d53f2054d9ae16a91274ffcb20a68a15c0855",
	    "pubkey": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwpYq+d5qkc3ReQ0To9t6\n9mRj5O5zR2pje0vJB9Cs7+tRAVfRcQx3NW/NL4BdgNRZiekf1rqnEsjy9QceEqCK\nrJJeyLnel6pQAb9zJQ9J1HCYIg/NpMJz+U7Wiwpmxd9uGbOY0GloGVCcO/DeAQVS\ne6l79Y3teiCF5qsM5FW/wSDnA87rK6HdNIKU+gsUgc+9kcywQ1T/rLyG4BRZ168E\npTJMsgRY0uUizCtzvoqV8y0ZE1+1x1oJ3EmgFq7HK258C4vhP/AJYFl9mB5WYYpo\nLz3dSGnnLwn0naU1m6THl5CJVmxf/6JPj7AeGme2KmAdVtaH4WImYg2TwCeIuGQo\nkwIDAQAB\n-----END PUBLIC KEY-----\n"}
	
seed.public = pki.publicKeyFromPem(seed.pubkey);
seed.hashname = key2hn(seed.public);

function getId(callback)
{
	if(localStorage.pubkey)
	{
		var ret = {public:pki.publicKeyFromPem(localStorage.pubkey), private:pki.privateKeyFromPem(localStorage.prikey)}
		console.log("returning key",ret);
		return callback(ret);
	}

	// generate/save one nicely
	console.log("generating 2048 rsa keypair");
	var state = rsa.createKeyPairGenerationState(2048, 0x10001);
	var steps = 0;
	var step = function() {
	  // run for 100 ms
	  if(!rsa.stepKeyPairGenerationState(state, 100)) {
		console.log("step",steps++);
	    setTimeout(step, 1);
	  } else {
		localStorage.pubkey = pki.publicKeyToPem(state.keys.publicKey);
		localStorage.prikey = pki.privateKeyToPem(state.keys.privateKey);
		getId(callback);
	  }
	};
	setTimeout(step);	
}


getId(function(id){
	document.forms[0][0].value = key2hn(id.public);
	openize(id, seed);
})

function ecKey()
{
	var c = getSECCurveByName("secp256r1");
	//var curve = new ECCurveFp(c.getCurve().getQ(), c.getCurve().getA().toBigInteger(), c.getCurve().getB().toBigInteger());
	//console.log(curve);
	var n = c.getN();
	var n1 = n.subtract(BigInteger.ONE);
	var r = new BigInteger(n.bitLength(), new SecureRandom());
	var priecc = r.mod(n1).add(BigInteger.ONE);
	//console.log(priecc);

	//var G = new ECPointFp(c.getCurve(), c.getCurve().fromBigInteger(c.getG().getX().toBigInteger(), c.getG().getY().toBigInteger());
	//console.log(G);
	var P = c.getG().multiply(priecc);
	document.forms[0][1].value = P.getX().toBigInteger().toString(16);
	document.forms[0][2].value = P.getY().toBigInteger().toString(16);
	P.uncompressed = forge.util.hexToBytes("04"+P.getX().toBigInteger().toString(16)+P.getY().toBigInteger().toString(16));
	//console.log(forge.util.createBuffer(forge.util.hexToBytes(P.getX().toBigInteger().toString(16))).toHex());
	return {curve:c, private:priecc, public:P};
}


var ecc;
function openize(id, to)
{
	ecc = ecKey();
	var inner = {}
	inner.at = Date.now();
	inner.to = to.hashname;
	inner.line = forge.util.bytesToHex(forge.random.getBytesSync(16));
	var body = pencode(inner, asn1.toDer(pki.publicKeyToAsn1(id.public)).bytes());
	var open = {type:"open"};
	var iv = forge.random.getBytesSync(16);
	open.iv = forge.util.bytesToHex(iv);

	// now encrypt the body
	var md = forge.md.sha256.create();
	md.update(ecc.public.uncompressed);
	var cipher = forge.aes.createEncryptionCipher(md.digest(), "CTR");
	cipher.start(iv);
	cipher.update(body);
	cipher.finish();
	body = cipher.output;

	// sign
	var md = forge.md.sha256.create();
	md.update(body.bytes());
	open.sig = forge.util.encode64(id.private.sign(md));

	// encrypt the ecc key
	open.open = forge.util.encode64(to.public.encrypt(ecc.public.uncompressed, "RSA-OAEP"));
	console.log(open, body.length());
	var packet = pencode(open, body.bytes());
	document.forms[0][3].value = packet.toHex()
}

function otest()
{
	var packet = forge.util.hexToBytes(document.forms[0][4].value);
	getId(function(id){
		deopenize(id, packet);
	});
}



function deopenize(id, packet)
{
	var open = pdecode(packet);
	if(!open) return console.log("couldn't parse",packet);
	console.log(open);
	// decrypt the ecc key
	var dec = forge.util.decode64(open.js.open);
	var ecpub = id.private.decrypt(dec, "RSA-OAEP");
	console.log(ecpub.length);
	// compose the aes key
	var md = forge.md.sha256.create();
	md.update(ecpub);
	var cipher = forge.aes.createDecryptionCipher(md.digest(), "CTR");
	cipher.start(forge.util.hexToBytes(open.js.iv));
	cipher.update(forge.util.createBuffer(open.body));
	cipher.finish();
	var inner = pdecode(cipher.output);
	console.log(inner);
	var rsapub = pki.publicKeyFromAsn1(asn1.fromDer(inner.body));
	console.log("from", key2hn(rsapub));
	var md = forge.md.sha256.create()
	md.update(open.body);
	var verify = rsapub.verify(md.digest().bytes(), forge.util.decode64(open.js.sig));
	console.log("verify", verify);
	ecdh(ecc.private, ecpub);
}

function ecdh(priv, pubbytes) {
  var curve = getSECCurveByName("secp256r1").getCurve();
  var uncompressed = forge.util.createBuffer(pubbytes);
console.log(uncompressed.length(), uncompressed.bytes());
  uncompressed.getByte(); // chop off the 0x04
  var x = uncompressed.getBytes(32);
  var y = uncompressed.getBytes(32);
console.log(x.length, y.length);
  if(y.length != 32) return false;
  var P = new ECPointFp(curve,
    curve.fromBigInteger(new BigInteger(forge.util.bytesToHex(x), 16)),
    curve.fromBigInteger(new BigInteger(forge.util.bytesToHex(y), 16)));
  var S = P.multiply(priv);
  console.log("shared secret",S.getX().toBigInteger().toString(16));
}


	</script>
</body>
</html>