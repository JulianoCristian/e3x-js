<!doctype html>
<html>
    <head>
        <title>Chat</title>
        <style type="text/css">
        /* reset-min.css */
html{color:#000;background:#FFF;}body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,code,form,fieldset,legend,input,textarea,p,blockquote,th,td{margin:0;padding:0;}table{border-collapse:collapse;border-spacing:0;}fieldset,img{border:0;}address,caption,cite,code,dfn,em,strong,th,var{font-style:normal;font-weight:normal;}li{list-style:none;}caption,th{text-align:left;}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal;}q:before,q:after{content:'';}abbr,acronym{border:0;font-variant:normal;}sup{vertical-align:text-top;}sub{vertical-align:text-bottom;}input,textarea,select{font-family:inherit;font-size:inherit;font-weight:inherit;}input,textarea,select{*font-size:100%;}legend{color:#000;}

            /* Global */
            html, body { height: 100%; }
            body { font-family: sans-serif; }
            #error { display: none; color: #d00; }

            /* Join form */
            #join-form { display: none; padding: 1em; }
            #nick-input { margin-bottom: 1em; }

            /* Chat */
            #chat { display: none; height: 100%; }
            #main { width: 80%; height: 100%; float: left; }
            #messages { height: 90%; overflow-y: scroll; background-color: #eee; }
            #message-form { height: 10%; }
            #message-input { width: 100%; height: 100%; padding: 0 1em; border: none; outline: none; }
            #users { width: 20%; height: 100%; float: left; background-color: #ddd; }
            .sender { font-weight: bold; }
            .system-message { font-style: italic; }

        </style>
        <script src="jquery.min.js"></script>
        <script src="jquery.tmpl.min.js"></script>
        <script src="/includes/forge.min.js"></script>
        <script src="/includes/jsbn.js"></script>
        <script src="/includes/jsbn2.js"></script>
        <script src="/includes/ec.js"></script>
        <script src="/includes/sec.js"></script>
        <script src="/includes/prng4.js"></script>
        <script src="/includes/rng.js"></script>
      	<script src="/thjs.js"></script>
      	<script src="/thforge.js"></script>
      	<script src="/seeds.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
        thforge.forge(forge);
        thjs.debug(function(){console.log.apply(console,arguments)});
        function getId(callback)
        {
        	if(localStorage.pubkey)
        	{
        		var ret = {public:localStorage.pubkey, private:localStorage.prikey}
        		console.log("returning key",ret);
        		return callback(ret);
        	}

        	// generate/save one nicely
        	window.alert("generating private local id, this only happens once and should be less than 30 seconds");
        	var state = forge.rsa.createKeyPairGenerationState(2048, 0x10001);
        	var steps = 0;
        	var step = function() {
        	  // run for 100 ms
        	  if(!forge.rsa.stepKeyPairGenerationState(state, 100)) {
        		console.log("step",steps++);
        	    setTimeout(step, 1);
        	  } else {
        		localStorage.pubkey = forge.pki.publicKeyToPem(state.keys.publicKey);
        		localStorage.prikey = forge.pki.privateKeyToPem(state.keys.privateKey);
            window.alert("done!")
        		getId(callback);
        	  }
        	};
        	setTimeout(step);	
        }
        </script>
    </head>

    <body>

      <div id="error">something went wrong</div>

        <form id="join-form">
            <label for="nick-input">Choose a nickname: </label><input id="nick-input" /><br />
            <label for="room-input">Enter a room id ("name" to create, or "name@host" to join): </label><input id="room-input" /><br />
            <input type="submit" value="Go" />
        </form>

        <div id="chat">
            <div id="main">
                <ul id="messages"></ul>
                <form id="message-form">
                    <input id="message-input" />
                </form>
            </div>
            <ul id="users"></ul>
        </div>

        <script id="userTemplate" type="text/x-jquery-tmpl">
            <li id="user-${user}">${user}</li>
        </script>

        <script id="chatMessageTemplate" type="text/x-jquery-tmpl">
            <li><span class="sender">${sender}</span>: ${message}</li>
        </script>

        <script id="systemMessageTemplate" type="text/x-jquery-tmpl">
            <li class="system-message">${message}</li>
        </script>

        <script>

            $(document).ready(function() {

              var me;
              getId(function(id){
          	    var socket = io.connect("//localhost:8008");
                console.log(socket);
          	    socket.on('connected', function(data) {
          	    	console.log("Socket connected",data);
          	    	me = thjs.hashname(id, function(to, msg) {
                    console.log("sending", to.hashname, msg.length());
                    socket.emit("message", {ip: to.ip, port: to.port, message: forge.util.encode64(msg.bytes())});
                  });
          	    	console.log("switch created",me);
          				seeds.forEach(me.addSeed, me);
          				me.online(function(err,to){
          					console.log("online",err,me.hashname);
                    if(err){
                      $("#error").html = err;
                      $("#error").show();
                      return;
                    }
                    $("#join-form").show();
                    $("#nick-input").focus();
                    $("#join-form").submit(function(ev) {
                      ev.preventDefault();
                      function log(message){
                        $("#systemMessageTemplate").tmpl({message: message}).appendTo("#messages");
                        $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                      }
                      function chat(nick, message){
                        $("#chatMessageTemplate").tmpl({sender:nick, message: message}).appendTo("#messages");
                        $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                      }
                      function join(user) {
                        $("#userTemplate").tmpl({user: user}).appendTo("#users");
                        log(user+" joined");
                      }
                      function handshake(err, arg, chan, cb)
                      {
                        if(err) return console.log("handshake err",err);
                        var mnick = (arg.js.nick) ? arg.js.nick : chan.hashname.substr(0,6);
                        if(!members[chan.hashname]) join(mnick);
                        members[chan.hashname] = chan;
                        chan.callback = function(err, arg, chan, cb2){
                          console.log("chatmsg",err,arg);
                          if(err)
                          {
                            $("#user-" + mnick).remove();
                            log(mnick+" left");
                            delete members[chan.hashname];
                          }
                          if(arg && arg.js.message) chat(mnick, arg.js.message);
                          cb2();
                        };
                        cb();
                      }
                        $("#join-form").hide();
                        $("#chat").show();
                        var nick = $("#nick-input").val();
                        if(!nick || nick == "") nick = "anon";
                        join(nick);
                        var room = $("#room-input").val();
                        var parts = room.split("@");
                        room = parts[0];
                        var hosthash = parts[1];
                        var members = {};
                        if(hosthash) {
                          var host = me.whois(hosthash);
                          if(!host) return log("invalid host: "+hosthash);
                          host.start("members", {js:{room:room}}, function(err, arg, chan, cb){
                            if(arg && Array.isArray(arg.js.members)) arg.js.members.forEach(function(member){
                              if(members[member]) return;
                              me.whois(member).start("chat", {js:{nick:nick, room:room}}, handshake);
                            });
                            cb();
                          });
                          log("joining "+room+" via "+hosthash);
                        } else {
                          log("hosting room, others can use '"+room+"@"+me.hashname+"' to join");
                        }
                        // any incoming chat message
                        me.listen("chat", function(err, arg, chan, cb){
                          console.log("chat",arg);
                          if(room != arg.js.room) return chan.end("unknown room");
                          handshake(false, arg, chan, cb);
                          chan.send({js:{nick:nick}});
                        });
                        // respond to incoming membership listing request
                        me.listen("members", function(err, arg, chan, cb){
                          console.log("members",arg);
                          cb();
                          // send members in chunks
                          var mlist = Object.keys(members);
                          mlist.push(me.hashname);
                          while(mlist.length > 0)
                          {
                            var chunk = mlist.slice(0, 10);
                            mlist = mlist.slice(10);
                            chan.send({js:{members:chunk}});
                            if(mlist.length == 0) chan.end();
                          }
                        });
                        $("#message-input").focus();
                        $("#message-form").submit(function(ev) {
                            ev.preventDefault();
                            var message = $("#message-input").val();
                            $("#message-input").val("");
                            chat(nick, message);
                            Object.keys(members).forEach(function(member){
                              console.log("message to",member,members[member]);
                              members[member].send({js:{"message":message}});
                            })
                        });
                    });

          				});
          	    });

          	    socket.on("message", function(data) {
          	    	console.log("incoming", data.message.length);
          	    	me.receive(forge.util.decode64(data.message), data.from);
          	    });

          	    socket.on("local", function(data) {
          	    	console.log("local address update", data);
                  me.ip = data.ip;
                  me.port = data.port;
          	    });
                
              });
                
            });
        </script>
    </body>
</html>