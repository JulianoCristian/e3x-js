<!doctype html>
<html>
<head>
  <title>Socket Demo</title>
  <script src="/includes/forge.min.js"></script>
  <script src="/includes/jsbn.js"></script>
  <script src="/includes/jsbn2.js"></script>
  <script src="/includes/ec.js"></script>
  <script src="/includes/sec.js"></script>
  <script src="/includes/prng4.js"></script>
  <script src="/includes/rng.js"></script>
	<script src="/lib/dhash.js"></script>
	<script src="/lib/util.js"></script>
	<script src="/lib/open.js"></script>
	<script src="/lib/switch.js"></script>
	<script src="/seeds.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>

  <script>
var open;
var rsa = forge.pki.rsa;
var pki = forge.pki;
var asn1 = forge.asn1;

var me;

getId(function(id){
	    var socket = io.connect(document.URL);
	    socket.on('connected', function(data) {
	    	me = hashname(id, function(to, msg) {
	    		console.log("sending", to, msg.length);
	    		socket.emit("message", {ip: to.ip, port: to.port, message: forge.util.encode64(msg)});
	    	});
	    	console.log("Socket connected",me);
				seeds.forEach(me.addSeed);
				me.online(function(err,to){
					console.log("online",err);
					if(to)
					{
						var packet = pencode({"seq":0,"type":"seek","seek":me.hashname,"stream":forge.util.bytesToHex(forge.random.getBytesSync(16))});
//						packet = packet.bytes();
						console.log("SENDING",forge.util.bytesToHex(packet.bytes()));
						to.line(packet);
					}
				})
	    });

	    socket.on("message", function(data) {
	    	console.log("incoming", data);
	    	me.onMessage(forge.util.decode64(data.message), data.from);
	    });
});


function getId(callback)
{
	if(localStorage.pubkey)
	{
		var ret = {public:pki.publicKeyFromPem(localStorage.pubkey), private:pki.privateKeyFromPem(localStorage.prikey)}
		console.log("returning key",ret);
		return callback(ret);
	}

	// generate/save one nicely
	console.log("generating 2048 rsa keypair");
	var state = rsa.createKeyPairGenerationState(2048, 0x10001);
	var steps = 0;
	var step = function() {
	  // run for 100 ms
	  if(!rsa.stepKeyPairGenerationState(state, 100)) {
		console.log("step",steps++);
	    setTimeout(step, 1);
	  } else {
		localStorage.pubkey = pki.publicKeyToPem(state.keys.publicKey);
		localStorage.prikey = pki.privateKeyToPem(state.keys.privateKey);
		getId(callback);
	  }
	};
	setTimeout(step);	
}

 
  
  </script>
</body>
</html>